import{_ as s,c as a,o as n,a as l}from"./app.c71ef9f6.js";const C=JSON.parse('{"title":"\u4F7F\u7528 Scrapy \u4E0B\u8F7D\u56FE\u7247","description":"","frontmatter":{},"headers":[{"level":2,"title":"\u9879\u76EE\u51C6\u5907","slug":"\u9879\u76EE\u51C6\u5907"},{"level":2,"title":"\u6570\u636E\u5EFA\u6A21","slug":"\u6570\u636E\u5EFA\u6A21"},{"level":2,"title":"\u722C\u866B\u4FEE\u6539","slug":"\u722C\u866B\u4FEE\u6539"},{"level":2,"title":"\u9879\u76EE\u8BBE\u7F6E","slug":"\u9879\u76EE\u8BBE\u7F6E"},{"level":2,"title":"\u6DFB\u52A0\u81EA\u5B9A\u4E49\u7BA1\u9053","slug":"\u6DFB\u52A0\u81EA\u5B9A\u4E49\u7BA1\u9053"},{"level":2,"title":"\u5B98\u65B9\u6587\u6863\u5730\u5740","slug":"\u5B98\u65B9\u6587\u6863\u5730\u5740"}],"relativePath":"guide/downloading-and-processing-images.md","lastUpdated":1660293772000}'),p={name:"guide/downloading-and-processing-images.md"},o=l(`<h1 id="\u4F7F\u7528-scrapy-\u4E0B\u8F7D\u56FE\u7247" tabindex="-1">\u4F7F\u7528 Scrapy \u4E0B\u8F7D\u56FE\u7247 <a class="header-anchor" href="#\u4F7F\u7528-scrapy-\u4E0B\u8F7D\u56FE\u7247" aria-hidden="true">#</a></h1><h2 id="\u9879\u76EE\u51C6\u5907" tabindex="-1">\u9879\u76EE\u51C6\u5907 <a class="header-anchor" href="#\u9879\u76EE\u51C6\u5907" aria-hidden="true">#</a></h2><blockquote><p>\u26A0\uFE0F\u26A0\uFE0F\u26A0\uFE0F<strong>\u6CE8\u610F\uFF1A</strong> \u4E0B\u8F7D\u56FE\u7247\u529F\u80FD\u4F9D\u8D56 <code>Pillow</code> \u7EC4\u4EF6\uFF0C\u4F7F\u7528 <code>pip</code> \u4E0B\u8F7D\u3002</p></blockquote><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">pip install Scrapy Pillow</span></span>
<span class="line"></span></code></pre></div><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">srapy startproject umei umei.cc   </span><span style="color:#676E95;font-style:italic;"># \u521B\u5EFA\u9879\u76EE</span></span>
<span class="line"><span style="color:#A6ACCD;">scrapy genspider download_images umei.cc  </span><span style="color:#676E95;font-style:italic;"># \u521B\u5EFA\u8718\u86DB\u6587\u4EF6</span></span>
<span class="line"></span></code></pre></div><h2 id="\u6570\u636E\u5EFA\u6A21" tabindex="-1">\u6570\u636E\u5EFA\u6A21 <a class="header-anchor" href="#\u6570\u636E\u5EFA\u6A21" aria-hidden="true">#</a></h2><p>\u6570\u636E\u5EFA\u6A21\u6587\u4EF6\uFF1A<code>items.py</code>\uFF0C\u4E2D\u7F16\u5199 <code>image_urls</code> \u548C <code>images</code> \u5B57\u6BB5</p><div class="language-python"><span class="copy"></span><div class="highlight-lines"><br><br><br><br><br><div class="highlighted">\xA0</div><div class="highlighted">\xA0</div><br></div><pre><code><span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> scrapy</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">UmeiItem</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">scrapy</span><span style="color:#89DDFF;">.</span><span style="color:#FFCB6B;">Item</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">id</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> scrapy</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Field</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># \u8BE6\u60C5ID</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    image_urls </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> scrapy</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Field</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># \u5B58\u50A8\u56FE\u7247URL</span></span>
<span class="line"><span style="color:#A6ACCD;">    images </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> scrapy</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Field</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;">#</span></span>
<span class="line"></span></code></pre></div><h2 id="\u722C\u866B\u4FEE\u6539" tabindex="-1">\u722C\u866B\u4FEE\u6539 <a class="header-anchor" href="#\u722C\u866B\u4FEE\u6539" aria-hidden="true">#</a></h2><p>\u722C\u866B\u6587\u4EF6\uFF1A<code>umei/spiders/download_images.py</code></p><div class="language-python"><span class="copy"></span><pre><code><span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> re</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> scrapy</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> hashlib</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">..</span><span style="color:#A6ACCD;">items </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> UmeiItem</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> scrapy</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">utils</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">python </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> to_bytes</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> scrapy_redis</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">spiders </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> RedisSpider</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">DownloadImagesSpider</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">RedisSpider</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    name </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">download_images</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># allowed_domains = [&#39;umei.cc&#39;, &#39;shanghai-jiuxin.com&#39;, &#39;zutuanla.com&#39;]</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># start_urls = [&#39;https://www.umei.cc/meinvtupian/meinvxiezhen/&#39;]</span></span>
<span class="line"><span style="color:#A6ACCD;">    redis_key </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">download_images:start_urls</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">__init__</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">args</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">**</span><span style="color:#A6ACCD;">kwargs</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#676E95;font-style:italic;"># Dynamically define the allowed domains list.</span></span>
<span class="line"><span style="color:#A6ACCD;">        domain </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> kwargs</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">pop</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">domain</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">&#39;&#39;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        self</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">allowed_domains</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">list</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">filter</span><span style="color:#89DDFF;">(None,</span><span style="color:#82AAFF;"> domain</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">split</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">)))</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">super</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">DownloadImagesSpider</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">__init__</span><span style="color:#89DDFF;">(*</span><span style="color:#82AAFF;">args</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">**</span><span style="color:#82AAFF;">kwargs</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">parse</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> response</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#676E95;font-style:italic;"># 1. \u5206\u6790\u76EE\u6807\u9875\u9762\u56FE\u7247\u5217\u8868\uFF0C\u627E\u5230\u56FE\u7247\u8BE6\u60C5\u9875</span></span>
<span class="line"><span style="color:#A6ACCD;">        image_detail_urls </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> response</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">xpath</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">//ul[contains(@class, &quot;pic-list&quot;)]/li/a/@href</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">getall</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> url </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> image_detail_urls</span><span style="color:#89DDFF;">[:</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">]:</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">id</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get_page_id</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">url</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;font-style:italic;">yield</span><span style="color:#A6ACCD;"> scrapy</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Request</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">url</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">response</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">urljoin</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">url</span><span style="color:#89DDFF;">),</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;">callback</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">parse_image_detail</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;">meta</span><span style="color:#89DDFF;">={</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#82AAFF;"> id</span><span style="color:#89DDFF;">})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># \u5904\u7406\u9875\u9762\u8BE6\u60C5</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">parse_image_detail</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> response</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#676E95;font-style:italic;"># 1. \u5206\u6790\u4E0B\u4E00\u9875\u56FE\u7247\u8BE6\u60C5\u548C\u5176\u4ED6\u7EC4\u56FE\u7247\u5730\u5740</span></span>
<span class="line"><span style="color:#A6ACCD;">        xpath </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">//div[@class=&quot;gongneng&quot;]//a/@href|//div[@class=&quot;img-box&quot;]/following-sibling::a/@href</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">        next_page_urls </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> response</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">xpath</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">xpath</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">getall</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> url </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> next_page_urls</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">id</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get_page_id</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">url</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;font-style:italic;">yield</span><span style="color:#A6ACCD;"> scrapy</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Request</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#82AAFF;">                </span><span style="color:#A6ACCD;">url</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">response</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">urljoin</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">url</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#82AAFF;">                </span><span style="color:#A6ACCD;">callback</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">parse_image_detail</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#82AAFF;">                </span><span style="color:#A6ACCD;">meta</span><span style="color:#89DDFF;">={</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#82AAFF;"> id</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#82AAFF;">            </span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#676E95;font-style:italic;"># 2. \u5206\u6790\u51FA\u9875\u9762\u4E2D\u5F85\u4E0B\u8F7D\u7684\u56FE\u7247\u5730\u5740</span></span>
<span class="line"><span style="color:#A6ACCD;">        image_url </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> response</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">xpath</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">//section[@class=&quot;img-content&quot;]//img/@src</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">        item </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">UmeiItem</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">        item</span><span style="color:#89DDFF;">[</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> response</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">request</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">meta</span><span style="color:#89DDFF;">[</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        item</span><span style="color:#89DDFF;">[</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">image_url</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> image_url</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">replace</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">http://kr.shanghai-jiuxin.com/</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">https://kr.zutuanla.com/</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        item</span><span style="color:#89DDFF;">[</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">path</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&#39;origin/</span><span style="color:#A6ACCD;">{item</span><span style="color:#89DDFF;">[</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;">}</span><span style="color:#C3E88D;">-</span><span style="color:#A6ACCD;">{hashlib</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sha1</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">to_bytes</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">image_url</span><span style="color:#89DDFF;">)).</span><span style="color:#82AAFF;">hexdigest</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;">}</span><span style="color:#C3E88D;">.jpg&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">yield</span><span style="color:#A6ACCD;"> item</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">get_page_id</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> url</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> re</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">compile</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">r</span><span style="color:#89DDFF;">&#39;(</span><span style="color:#F07178;">?P&lt;id&gt;</span><span style="color:#C3E88D;">\\d</span><span style="color:#89DDFF;">+)(</span><span style="color:#C3E88D;">_\\d</span><span style="color:#89DDFF;">+)*</span><span style="color:#C3E88D;">.htm</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> re</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">S</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">search</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">url</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">group</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span></code></pre></div><h2 id="\u9879\u76EE\u8BBE\u7F6E" tabindex="-1">\u9879\u76EE\u8BBE\u7F6E <a class="header-anchor" href="#\u9879\u76EE\u8BBE\u7F6E" aria-hidden="true">#</a></h2><p>\u914D\u7F6E\u6587\u4EF6\uFF1A<code>settings.py</code></p><div class="language-python"><span class="copy"></span><pre><code><span class="line"><span style="color:#676E95;font-style:italic;"># \u8BBE\u7F6E\u91CD\u590D\u8FC7\u6EE4\u6A21\u5757</span></span>
<span class="line"><span style="color:#A6ACCD;">DUPEFILTER_CLASS </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">scrapy_redis.dupefilter.RFPDupeFilter</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># \u8BBE\u7F6E\u8C03\u5EA6\u5668\uFF0Cscrapy_redis\u4E2D\u7684\u8C03\u5EA6\u5668\u5177\u5907\u548C\u6570\u636E\u5E93\u4EA4\u4E92\u7684\u529F\u80FD</span></span>
<span class="line"><span style="color:#A6ACCD;">SCHEDULER </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">scrapy_redis.scheduler.Scheduler</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># \u8BBE\u7F6E\u5F53\u722C\u866B\u7ED3\u675F\u65F6\u662F\u5426\u4FDD\u5B58 Redis \u6570\u636E\u5E93\u4E2D\u662F\u5426\u53BB\u91CD\u96C6\u5408\u4E0E\u4EFB\u52A1\u961F\u5217</span></span>
<span class="line"><span style="color:#A6ACCD;">SCHEDULER_PERSIST </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">True</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># \u6DFB\u52A0\u4E2D\u95F4\u4EF6\u7528\u4E8E\u56FE\u7247\u4E0B\u8F7D</span></span>
<span class="line"><span style="color:#A6ACCD;">ITEM_PIPELINES </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">umei.pipelines.UmeiPipeline</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">300</span><span style="color:#89DDFF;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># \u5F53\u5F00\u542F\u8BE5\u7BA1\u9053\uFF0C\u8BE5\u7BA1\u9053\u4F1A\u5C06\u6570\u636E\u5B58\u50A8\u5230 Redis \u6570\u636E\u5E93\u4E2D</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">scrapy_redis.pipelines.RedisPipeline</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">400</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># &#39;scrapy.pipelines.images.ImagesPipeline&#39;: 300,</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">DEFAULT_IMAGES_URLS_FIELD </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">image_url</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">IMAGES_STORE </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">images</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># IMAGES_THUMBS = {</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">#     &#39;small&#39;: (100, 100),</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">#     &#39;big&#39;: (340, 340),</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># }</span></span>
<span class="line"><span style="color:#A6ACCD;">IMAGES_EXPIRES </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">90</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># \u6587\u4EF6\u8FC7\u671F\u5EF6\u8FDF 90 \u5929</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">DOWNLOAD_DELAY </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0.5</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># \u9879\u76EE\u7BA1\u9053\u5E8F\u5217\u5316\u5E76\u5B58\u50A8\u6B64redis\u5BC6\u94A5\u4E2D\u7684\u9879\u76EE\u3002</span></span>
<span class="line"><span style="color:#A6ACCD;">REDIS_ITEMS_KEY </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">www.umei.cc:meinvtupian:meinvxiezhen:items</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># \u6307\u5B9A\u8FDE\u63A5\u5230Redis\u65F6\u8981\u4F7F\u7528\u7684\u4E3B\u673A\u548C\u7AEF\u53E3\uFF08\u53EF\u9009\uFF09\u3002</span></span>
<span class="line"><span style="color:#A6ACCD;">REDIS_HOST </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">localhost</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">REDIS_PORT </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">6379</span></span>
<span class="line"><span style="color:#A6ACCD;">REDIS_DB </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span></span>
<span class="line"></span></code></pre></div><h2 id="\u6DFB\u52A0\u81EA\u5B9A\u4E49\u7BA1\u9053" tabindex="-1">\u6DFB\u52A0\u81EA\u5B9A\u4E49\u7BA1\u9053 <a class="header-anchor" href="#\u6DFB\u52A0\u81EA\u5B9A\u4E49\u7BA1\u9053" aria-hidden="true">#</a></h2><p>\u9ED8\u8BA4\u7684\u7BA1\u9053\u7C7B <code>scrapy.pipelines.images.ImagesPipeline</code> \u5B58\u50A8\u7684\u6587\u4EF6\u540D\u4E0D\u6EE1\u8DB3\u9700\u6C42\uFF0C\u901A\u8FC7\u81EA\u5B9A\u4E49\u7BA1\u9053\u7C7B <code>pipelines.py</code> \u4E2D\u7F16\u5199\u81EA\u5B9A\u4E49\u903B\u8F91\uFF1A</p><div class="language-python"><span class="copy"></span><pre><code><span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> scrapy</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> scrapy</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">pipelines</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">images </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> ImagesPipeline</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">UmeiPipeline</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">ImagesPipeline</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">&quot;&quot;&quot;</span><span style="color:#676E95;font-style:italic;">\u81EA\u5B9A\u4E49\u56FE\u7247\u4E0B\u8F7D\u5668, \u6DFB\u52A0\u8D44\u6E90ID\u4F5C\u4E3A\u6587\u4EF6\u5939\u4FDD\u5B58\u56FE\u7247</span><span style="color:#89DDFF;font-style:italic;">&quot;&quot;&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">get_media_requests</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> item</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> info</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">&quot;&quot;&quot;</span><span style="color:#676E95;font-style:italic;">\u53D1\u751F\u56FE\u7247\u4E0B\u8F7D\u8BF7\u6C42</span><span style="color:#89DDFF;font-style:italic;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">yield</span><span style="color:#A6ACCD;"> scrapy</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Request</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">item</span><span style="color:#89DDFF;">[</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">image_url</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">],</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;">meta</span><span style="color:#89DDFF;">={</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">path</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#82AAFF;"> item</span><span style="color:#89DDFF;">[</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">path</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">]})</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># \u7EE7\u7EED\u4F20\u9012\u56FE\u7247\u5B58\u50A8\u8DEF\u5F84</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">file_path</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> request</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> response</span><span style="color:#89DDFF;">=None,</span><span style="color:#A6ACCD;"> info</span><span style="color:#89DDFF;">=None,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">, item</span><span style="color:#89DDFF;">=None):</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">&quot;&quot;&quot;</span><span style="color:#676E95;font-style:italic;">\u81EA\u5B9A\u4E49\u56FE\u7247\u4FDD\u5B58\u8DEF\u5F84</span><span style="color:#89DDFF;font-style:italic;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> request</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">meta</span><span style="color:#89DDFF;">[</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">path</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">]</span></span>
<span class="line"></span></code></pre></div><h1 id="\u542F\u52A8\u722C\u866B" tabindex="-1">\u542F\u52A8\u722C\u866B <a class="header-anchor" href="#\u542F\u52A8\u722C\u866B" aria-hidden="true">#</a></h1><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">scrapy crawl download_images</span></span>
<span class="line"><span style="color:#A6ACCD;">redis-cli -n 1 LPUSH download_images:start_urls </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">{&quot;url&quot;: &quot;https://www.umei.cc/meinvtupian/meinvxiezhen/&quot;}</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># \u5411Redis\u4E2D\u6DFB\u52A0\u6307\u5B9Akey</span></span>
<span class="line"></span></code></pre></div><h2 id="\u5B98\u65B9\u6587\u6863\u5730\u5740" tabindex="-1">\u5B98\u65B9\u6587\u6863\u5730\u5740 <a class="header-anchor" href="#\u5B98\u65B9\u6587\u6863\u5730\u5740" aria-hidden="true">#</a></h2><ul><li><a href="https://docs.scrapy.org/en/latest/topics/media-pipeline.html" target="_blank" rel="noopener noreferrer">Downloading and processing files and images\xB6</a></li></ul>`,21),e=[o];function t(c,r,D,y,F,i){return n(),a("div",null,e)}var d=s(p,[["render",t]]);export{C as __pageData,d as default};
